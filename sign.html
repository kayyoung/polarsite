<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Signature - Polarsite Toolkit</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230071e3'%3E%3C/rect%3E%3Ctext x='50' y='55' font-size='50' font-weight='600' fill='%23ffffff' text-anchor='middle' alignment-baseline='middle' font-family='-apple-system, BlinkMacSystemFont, sans-serif'%3EP%3C/text%3E%3C/svg%3E">
  <meta name="description" content="Sign PDFs with handwritten signatures or digital stamps.">
  
  <link href="css/output.css" rel="stylesheet">
  <script src="js/pdf-lib.min.js"></script>
  <script src="js/signature_pad.umd.min.js"></script>
  <script src="js/pdf.min.js"></script>
  
  <style>
    :root {
      --accent: #0071e3; --bg-light: #f5f5f7; --bg-dark: #111111; --card-light: #ffffff;
      --card-dark: #1c1c1e; --text-light: #1d1d1f; --text-dark: #f5f5f7;
      --text-sec-light: #6e6e73; --text-sec-dark: #a1a1a6; --border-light: #d2d2d7;
      --border-dark: #3a3a3c;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      background-color: var(--bg-light); color: var(--text-light);
    }
    @media (prefers-color-scheme: dark) {
      body { background-color: var(--bg-dark); color: var(--text-dark); }
      .card { background-color: var(--card-dark); border-color: var(--border-dark); }
    }
    .card {
      background-color: var(--card-light); border: 1px solid var(--border-light);
      border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04);
    }
    @media (prefers-color-scheme: dark) {
      .card {
        background-color: var(--card-dark); border-color: var(--border-dark);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
    }
    .text-secondary { color: var(--text-sec-light); }
    @media (prefers-color-scheme: dark) { .text-secondary { color: var(--text-sec-dark); } }
    .btn-primary { background-color: var(--accent); color: white; transition: opacity 0.2s; }
    .btn-primary:hover { opacity: 0.85; }
    .btn-secondary { background-color: var(--bg-light); transition: opacity 0.2s; }
    .btn-secondary:hover { opacity: 0.8; }
    @media (prefers-color-scheme: dark) {
      .btn-secondary { background-color: var(--card-dark); }
    }
    
    /* 预览区样式 */
    #preview-container {
      background-color: #525659;
      border-radius: 12px;
      min-height: 500px; /* 默认最小高度 */
      overflow: hidden; 
      position: relative;
      display: flex;
      flex-direction: column;
    }
    #pdf-scroll-view {
      flex: 1;
      overflow: auto;
      display: flex;
      justify-content: center;
      padding: 40px;
      position: relative;
    }
    #pdf-wrapper {
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      background: white;
    }
    .interactive-sig {
      position: absolute; cursor: grab; border: 2px dashed #0071e3; z-index: 50;
    }
    .interactive-sig:active { cursor: grabbing; border-style: solid; }
    .interactive-sig img { width: 100%; height: 100%; display: block; pointer-events: none; }
    .resize-handle {
      width: 12px; height: 12px; background: #0071e3; position: absolute; bottom: -6px; right: -6px;
      cursor: se-resize; border-radius: 50%; border: 2px solid white; z-index: 51;
    }
    .delete-handle {
      width: 20px; height: 20px; background: #ef4444; color: white; position: absolute; top: -10px; right: -10px;
      cursor: pointer; border-radius: 50%; text-align: center; line-height: 18px; font-size: 14px; border: 2px solid white; z-index: 51;
    }
    
    /* Tabs */
    .tab-btn { background-color: transparent; opacity: 0.7; }
    .tab-btn.active { opacity: 1; font-weight: 600; color: var(--accent); border-bottom: 2px solid var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="antialiased">

  <header class="sticky top-0 z-50 w-full border-b border-[var(--border-light)] bg-white/80 backdrop-blur-sm dark:border-[var(--border-dark)] dark:bg-[var(--bg-dark)]/80">
    <nav class="mx-auto flex max-w-7xl items-center justify-between p-4 lg:px-8">
      <a href="index.html" class="flex items-center gap-2">
        <svg width="32" height="32" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <rect width="100" height="100" rx="22" fill="#0071e3"></rect>
          <text x="50" y="55" font-size="50" font-weight="600" fill="#ffffff" text-anchor="middle" alignment-baseline="middle" font-family="-apple-system, BlinkMacSystemFont, sans-serif">P</text>
        </svg>
        <span class="text-xl font-semibold tracking-tight" style="color: var(--text-light); dark:color: var(--text-dark);">Polarsite</span>
      </a>
      <div class="hidden items-center gap-6 text-[15px] font-medium md:flex">
        <a href="index.html" class="nav-link" data-en="Home" data-zh="首页">Home</a>
        <a href="about.html" class="nav-link" data-en="About" data-zh="关于">About</a>
        <a href="privacy.html" class="nav-link" data-en="Privacy" data-zh="隐私">Privacy</a>
        <a href="https://github.com/kayyoung/polarsite" target="_blank" class="text-secondary">GitHub</a>
      </div>
      <button id="lang-toggle" class="rounded-lg bg-[var(--bg-light)] px-3 py-1.5 text-sm font-medium hover:opacity-80 dark:bg-[var(--card-dark)]">
        中文
      </button>
    </nav>
  </header>

  <main class="mx-auto max-w-7xl p-4 py-10 lg:px-8">
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold tracking-tighter mb-4" data-en="✍️ E-Signature" data-zh="✍️ 电子签名">✍️ 电子签名</h1>
      <p class="text-lg text-secondary" data-en="Draw, type, or upload signature and drag to place it on PDF." data-zh="绘制、输入或上传签名，然后拖拽到 PDF 上。">
        Draw, type, or upload signature and drag to place it on PDF.
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <div class="space-y-6">
        
        <div class="card p-6">
          <h2 class="text-xl font-semibold mb-4" data-en="1. Upload PDF" data-zh="1. 上传 PDF">1. Upload PDF</h2>
          <input type="file" id="pdf-input" class="hidden" accept=".pdf">
          <div id="drop-zone" class="border-2 border-dashed border-[var(--border-light)] dark:border-[var(--border-dark)] rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors">
            <p class="text-secondary" data-en="Click to upload PDF" data-zh="点击上传 PDF 文件">Click to upload PDF</p>
          </div>
        </div>

        <div class="card p-6">
          <h2 class="text-xl font-semibold mb-4" data-en="2. Create Signature" data-zh="2. 创建签名">2. Create Signature</h2>
          
          <div class="flex border-b border-[var(--border-light)] dark:border-[var(--border-dark)] mb-4">
            <button id="tab-draw" class="tab-btn active flex-1 pb-2 text-sm font-medium" data-en="Draw" data-zh="手绘">Draw</button>
            <button id="tab-type" class="tab-btn flex-1 pb-2 text-sm font-medium" data-en="Type" data-zh="输入">Type</button>
            <button id="tab-upload" class="tab-btn flex-1 pb-2 text-sm font-medium" data-en="Image" data-zh="图片">Image</button>
          </div>

          <div id="content-draw" class="tab-content active">
            <canvas id="signature-pad" class="w-full h-32 bg-white dark:bg-gray-800 border border-[var(--border-light)] rounded-lg mb-3 touch-none"></canvas>
            <div class="flex gap-3">
              <button id="clear-draw" class="flex-1 btn-secondary rounded-lg py-2 text-sm font-medium" data-en="Clear" data-zh="清除">Clear</button>
              <button id="use-draw" class="flex-1 btn-primary rounded-lg py-2 text-sm font-medium" data-en="Use This" data-zh="使用签名">Use This</button>
            </div>
          </div>

          <div id="content-type" class="tab-content">
            <input type="text" id="text-input" class="w-full p-3 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded-lg mb-3 bg-transparent" placeholder="Your Name" data-en-placeholder="Your Name" data-zh-placeholder="您的姓名">
            <button id="use-type" class="w-full btn-primary rounded-lg py-2 text-sm font-medium" data-en="Generate & Use" data-zh="生成并使用">Generate & Use</button>
          </div>

          <div id="content-upload" class="tab-content">
            <input type="file" id="img-input" class="hidden" accept="image/*">
            <button onclick="document.getElementById('img-input').click()" class="w-full py-8 border-2 border-dashed border-[var(--border-light)] rounded-lg text-sm text-secondary hover:border-blue-500" data-en="Click to Upload Image" data-zh="点击上传图片">
              Click to Upload Image
            </button>
          </div>
        </div>

        <div class="card p-6">
          <button id="download-btn" class="w-full btn-primary rounded-lg px-4 py-3 text-lg font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled data-en="Download Signed PDF" data-zh="下载签名后的 PDF">
            Download Signed PDF
          </button>
          <div id="status" class="mt-3 text-center text-sm text-secondary min-h-[20px]"></div>
        </div>

      </div>

      <div class="lg:col-span-1">
        <div id="preview-container">
          <div class="flex justify-between items-center p-3 bg-gray-800 text-white text-sm z-10 shadow-md">
             <div class="flex gap-4 items-center">
                <span>Page <span id="curr-page">0</span> / <span id="total-pages">0</span></span>
                <div class="flex items-center gap-2 bg-gray-700 rounded px-2">
                   <button id="zoom-out" class="px-2 py-1 font-bold hover:text-blue-300">-</button>
                   <span id="zoom-level">100%</span>
                   <button id="zoom-in" class="px-2 py-1 font-bold hover:text-blue-300">+</button>
                </div>
             </div>
             <div class="flex gap-2">
                <button id="prev-page" class="px-3 py-1 bg-gray-600 rounded hover:bg-gray-500 disabled:opacity-50">Prev</button>
                <button id="next-page" class="px-3 py-1 bg-gray-600 rounded hover:bg-gray-500 disabled:opacity-50">Next</button>
             </div>
          </div>

          <div id="pdf-scroll-view">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400" data-en="Upload PDF to Preview" data-zh="上传 PDF 以预览">
              <svg class="w-16 h-16 mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              <p>Upload PDF to Preview</p>
            </div>
            
            <div id="pdf-wrapper" style="display:none;">
               <canvas id="pdf-canvas"></canvas>
               </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer class="mt-20 border-t border-[var(--border-light)] py-16 dark:border-[var(--border-dark)]">
    <div class="mx-auto max-w-7xl px-4 lg:px-8">
      <div class="grid grid-cols-1 gap-12 md:grid-cols-3">
        <div>
          <h3 class="text-lg font-semibold mb-2" data-en="About Polarsite" data-zh="关于 极地">About Polarsite</h3>
          <p class="text-secondary" data-en="Secure, client-side tools for professionals. Your data never leaves your device." data-zh="安全、私密的浏览器端专业工具。您的数据永不离开您的设备。">
            Secure, client-side tools for professionals. Your data never leaves your device.
          </p>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2" data-en="Sponsor Us" data-zh="支持我们">Sponsor Us</h3>
          <p class="text-secondary mb-4" data-en="If you find these tools helpful, consider supporting their development." data-zh="如果您觉得这些工具对您有帮助，请考虑支持我们开发。">
            If you find these tools helpful, consider supporting their development.
          </p>
          <div class="flex gap-4">
             <div class="flex h-24 w-24 items-center justify-center rounded-lg bg-[var(--bg-light)] text-secondary dark:bg-[var(--card-dark)]" data-en="QR Placeholder" data-zh="二维码占位">QR Placeholder</div>
             <div class="flex h-24 w-24 items-center justify-center rounded-lg bg-[var(--bg-light)] text-secondary dark:bg-[var(--card-dark)]" data-en="QR Placeholder" data-zh="二维码占位">QR Placeholder</div>
          </div>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2" data-en="Advertisement" data-zh="广告">Advertisement</h3>
          <p class="text-secondary" data-en="AdSense slot will be here." data-zh="AdSense 广告位">AdSense slot will be here.</p>
        </div>
      </div>
      <div class="mt-12 border-t border-[var(--border-light)] pt-8 text-center text-secondary dark:border-[var(--border-dark)]">
        © 2025 Polarsite · <a href="mailto:admin@polarsite.site" class="hover:underline">admin@polarsite.site</a>
      </div>
    </div>
  </footer>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf.worker.min.js';

    class App {
      constructor() {
        this.pdfDoc = null;
        this.pdfBytes = null;
        this.pageNum = 1;
        this.scale = 1.0; 
        
        this.wrapper = document.getElementById('pdf-wrapper');
        this.canvas = document.getElementById('pdf-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.viewport = document.getElementById('pdf-scroll-view');
        
        this.initPad();
        this.bindEvents();
      }

      initPad() {
        const canvas = document.getElementById('signature-pad');
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        this.pad = new SignaturePad(canvas, { backgroundColor: 'rgba(0,0,0,0)' });
      }

      bindEvents() {
        // 1. Upload (修复 ArrayBuffer Detached 错误)
        document.getElementById('pdf-input').addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          
          const buffer = await file.arrayBuffer();
          this.pdfBytes = buffer.slice(0); // 保存原始 Buffer 的副本用于下载 (关键修复点)
          
          const loadingTask = pdfjsLib.getDocument(buffer); // 使用原始 buffer (或副本) 进行渲染
          this.pdfDoc = await loadingTask.promise;
          
          document.getElementById('total-pages').textContent = this.pdfDoc.numPages;
          document.getElementById('empty-state').style.display = 'none';
          this.wrapper.style.display = 'block';
          document.getElementById('download-btn').disabled = false;
          
          this.pageNum = 1;
          this.renderPage(true); // true = auto fit
        });

        document.getElementById('drop-zone').onclick = () => document.getElementById('pdf-input').click();

        // 2. Zoom & Nav
        document.getElementById('zoom-in').onclick = () => { this.scale += 0.1; this.renderPage(); };
        document.getElementById('zoom-out').onclick = () => { if(this.scale > 0.3) { this.scale -= 0.1; this.renderPage(); }};
        document.getElementById('prev-page').onclick = () => { if(this.pageNum > 1) { this.pageNum--; this.renderPage(); }};
        document.getElementById('next-page').onclick = () => { if(this.pageNum < this.pdfDoc.numPages) { this.pageNum++; this.renderPage(); }};

        // 3. Tabs
        ['draw', 'type', 'upload'].forEach(t => {
            document.getElementById(`tab-${t}`).onclick = (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(`content-${t}`).classList.add('active');
            };
        });

        // 4. Signature Actions (Use This 按钮逻辑)
        document.getElementById('clear-draw').onclick = () => this.pad.clear();
        
        const addSig = (url) => this.createSigElement(url);

        document.getElementById('use-draw').onclick = () => {
            if(this.pad.isEmpty()) return alert('Please draw first');
            addSig(this.pad.toDataURL());
        };

        document.getElementById('use-type').onclick = () => {
            const text = document.getElementById('text-input').value;
            if(!text) return;
            const c = document.createElement('canvas');
            const cx = c.getContext('2d');
            c.width = 600; c.height = 150;
            cx.font = '60px sans-serif';
            cx.fillText(text, 10, 100);
            addSig(c.toDataURL());
        };

        document.getElementById('img-input').onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = ev => addSig(ev.target.result);
                r.readAsDataURL(f);
            }
        };

        // 5. Download
        document.getElementById('download-btn').onclick = () => this.download();
      }

      async renderPage(autoFit = false) {
        if(!this.pdfDoc) return;
        const page = await this.pdfDoc.getPage(this.pageNum);
        const vpBase = page.getViewport({ scale: 1 });
        
        if(autoFit) {
            // 自适应逻辑：宽度适应容器，高度自适应滚动
            const containerWidth = this.viewport.clientWidth - 80; // 减去 padding
            this.scale = containerWidth / vpBase.width;
            this.scale = Math.min(this.scale, 1.5); // 限制最大缩放倍数
        }
        
        const vp = page.getViewport({ scale: this.scale });
        this.canvas.width = vp.width;
        this.canvas.height = vp.height;
        this.wrapper.style.width = vp.width + 'px';
        this.wrapper.style.height = vp.height + 'px';
        
        await page.render({ canvasContext: this.ctx, viewport: vp }).promise;
        
        document.getElementById('curr-page').textContent = this.pageNum;
        document.getElementById('zoom-level').textContent = Math.round(this.scale * 100) + '%';
      }

      createSigElement(dataUrl) {
        if(!this.pdfDoc) return alert('Upload PDF first');
        const div = document.createElement('div');
        div.className = 'interactive-sig';
        div.style.left = '50px'; div.style.top = '50px'; div.style.width = '150px';
        
        const img = document.createElement('img');
        img.src = dataUrl;
        img.onload = () => div.style.height = (150 * img.naturalHeight / img.naturalWidth) + 'px';
        
        const del = document.createElement('div');
        del.className = 'delete-handle';
        del.innerHTML = '×';
        del.onclick = (e) => { e.stopPropagation(); div.remove(); };
        
        const res = document.createElement('div');
        res.className = 'resize-handle';
        
        div.append(img, del, res);
        this.wrapper.appendChild(div);
        
        this.makeDraggable(div, res);
      }

      makeDraggable(el, handle) {
        let isDrag = false, isRes = false;
        let startX, startY, startW, startL, startT;

        el.onmousedown = (e) => {
            if(e.target === handle || e.target.className === 'delete-handle') return;
            isDrag = true;
            startX = e.clientX; startY = e.clientY;
            startL = el.offsetLeft; startT = el.offsetTop;
            e.preventDefault();
        };

        handle.onmousedown = (e) => {
            isRes = true;
            startX = e.clientX;
            startW = el.offsetWidth;
            e.stopPropagation(); e.preventDefault();
        };

        window.onmousemove = (e) => {
            if(isDrag) {
                el.style.left = (startL + e.clientX - startX) + 'px';
                el.style.top = (startT + e.clientY - startY) + 'px';
            }
            if(isRes) {
                const dx = e.clientX - startX;
                const w = Math.max(30, startW + dx);
                el.style.width = w + 'px';
                const img = el.querySelector('img');
                if(img) el.style.height = (w * img.naturalHeight / img.naturalWidth) + 'px';
            }
        };

        window.onmouseup = () => { isDrag = false; isRes = false; };
      }

      async download() {
        if(!this.pdfBytes) return;
        document.getElementById('status').textContent = 'Generating PDF...';
        
        try {
            // 使用保存的原始 buffer副本 (已修复 ArrayBuffer detached)
            const pdfDoc = await PDFLib.PDFDocument.load(this.pdfBytes);
            const page = pdfDoc.getPages()[this.pageNum - 1];
            const { height } = page.getSize();
            
            // 计算缩放比 (PDF点数 / Canvas像素)
            const ratio = page.getSize().width / this.canvas.width;
            
            const sigs = this.wrapper.querySelectorAll('.interactive-sig');
            for(const el of sigs) {
                const img = el.querySelector('img');
                const rect = el.getBoundingClientRect();
                const wrap = this.wrapper.getBoundingClientRect();
                
                const x = (rect.left - wrap.left) * ratio;
                const w = el.offsetWidth * ratio;
                const h = el.offsetHeight * ratio;
                const y = height - ((rect.top - wrap.top) * ratio) - h; // Y轴从底部开始
                
                const embed = await pdfDoc.embedPng(img.src);
                page.drawImage(embed, { x, y, width: w, height: h });
            }
            
            const bytes = await pdfDoc.save();
            const blob = new Blob([bytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'signed.pdf';
            link.click();
            document.getElementById('status').textContent = 'Done!';
        } catch(e) {
            console.error(e);
            document.getElementById('status').textContent = 'Error saving.';
        }
      }
    }

    // 语言初始化系统 (恢复标准版逻辑)
    let currentLang = 'en';
    const langToggle = document.getElementById('lang-toggle');
    
    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      
      document.querySelectorAll('[data-en]').forEach(el => {
        if (lang === 'zh' && el.hasAttribute('data-zh')) {
          el.textContent = el.getAttribute('data-zh');
        } else {
          el.textContent = el.getAttribute('data-en');
        }
      });
      
      document.querySelectorAll('[data-en-placeholder]').forEach(el => {
        if (lang === 'zh' && el.hasAttribute('data-zh-placeholder')) {
          el.setAttribute('placeholder', el.getAttribute('data-zh-placeholder'));
        } else {
          el.setAttribute('placeholder', el.getAttribute('data-en-placeholder'));
        }
      });

      langToggle.textContent = lang === 'en' ? '中文' : 'English';
    }
    
    function toggleLanguage() {
      setLanguage(currentLang === 'en' ? 'zh' : 'en');
    }
    
    // 初始化逻辑：检查本地存储 -> 浏览器设置 -> 默认英文
    langToggle.addEventListener('click', toggleLanguage);
    const savedLang = localStorage.getItem('polarsite_lang');
    if (savedLang && ['en', 'zh'].includes(savedLang)) {
      setLanguage(savedLang);
    } else {
      const browserLang = navigator.language || navigator.userLanguage;
      if (browserLang.startsWith('zh')) {
        setLanguage('zh');
      }
    }
    
    // 保存语言偏好
    window.addEventListener('beforeunload', () => {
      localStorage.setItem('polarsite_lang', currentLang);
    });

    new App();
  </script>
</body>
</html>
